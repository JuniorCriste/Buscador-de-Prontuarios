<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>ARQUIVO INATIVO - JOS√â TEIXEIRA FIALHO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilos CSS (Mantidos) */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --error-color: #dc3545;
            --background-light: whitesmoke;
            --shadow-subtle: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-input: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Poppins', Arial, sans-serif; 
            background-color: var(--background-light);
            padding: 20px; 
            display: flex;
            justify-content: center;
        }

        .container {
            width: 90%;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow-subtle);
        }

        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        h2 {
            color: var(--secondary-color);
            margin-top: 25px;
            font-weight: 400;
            font-size: 1.5rem;
        }

        #input-container, #search-container { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            background-color: #f8f9fa;
            box-shadow: var(--shadow-input);
        }
        
        #auto-load-message {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e3f2fd; /* Azul bem claro para indicar processo */
            border-left: 5px solid var(--primary-color);
            border-radius: 4px;
            font-size: 0.9rem;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #343a40;
        }

        #file-input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: white;
        }

        #search-input {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        #search-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #search-container p {
            font-size: 0.85em; 
            color: var(--secondary-color);
            margin-top: 5px;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 123, 255, 0.75), rgba(0, 0, 0, 0));
            margin: 30px 0;
        }

        #search-results { 
            margin-top: 20px; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            padding: 15px; 
            min-height: 100px;
            background-color: white;
            box-shadow: var(--shadow-input);
        }
        
        #search-results p:first-child[style*="#28a745"] {
            font-weight: 600;
        }
        #search-results p[style*="#dc3545"] {
            font-weight: 600;
        }

        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        .data-table th, .data-table td { 
            border: 1px solid #e9ecef; 
            padding: 12px 15px; 
            text-align: left; 
            font-size: 0.70rem;
            
            width: auto; 
            max-width: 300px; 
            white-space: normal; 
            word-wrap: break-word; 
            
            overflow: hidden;
        }
        .data-table th { 
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa; 
        }
        .data-table tr:hover {
            background-color: #e2f0ff; 
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: scale(0.98);
        }

        #open-xlsx-link {
            text-decoration: none;
        }

    </style>
</head>
<body onload="attemptAutoLoad()">

    <div class="container">
        <h1>üîç Arquivo Inativo - JOS√â TEIXEIRA FIALHO</h1>

        <div id="input-container">
            <div id="auto-load-message">
                **Tentando carregar a planilha automaticamente** da URL do SharePoint...
            </div>
            <label for="file-input" id="file-label" style="display: none;">1. Selecione o arquivo XLSX para busca:</label>
            <input type="file" id="file-input" accept=".xlsx" onchange="handleFileManual(event)" style="display: none;">
        </div>

        <div id="search-container" style="display: none;">
            <label for="search-input">2. Digite o que deseja buscar (Nome, Filia√ß√£o, etc.):</label>
            <input type="text" id="search-input" placeholder="Ex: Maria da Silva" onkeyup="performSearch()">
            <p>O campo busca em todas as abas (A-Z) simultaneamente.</p>
        </div>

        <hr>

        <h2>Resultados da Busca:</h2>
        <div id="search-results">
            <p>Aguardando o carregamento da planilha...</p>
        </div>
        
        
    </div>

    <script>
        let fullData = {}; 
        const SUCCESS_COLOR = '#28a745';
        const ERROR_COLOR = '#dc3545';
        
        // üéØ NOVO CAMINHO: URL COMPLETA DO SHAREPOINT
        const AUTO_LOAD_PATH = 'https://educadorseduesgov-my.sharepoint.com/:x:/r/personal/escolajoseteixeira_sedu_es_gov_br/Documents/SECRETARIA/ARQUIVO%20INATIVO%20-%20VIGENTE.xlsx?d=w7a96fe586b9f439683286d5a6ca940ef&csf=1&web=1&e=PJD9lJ';

        // üéØ KEY_MAP: Mapeia cabe√ßalhos com acentos ou varia√ß√µes para uma chave padronizada no JS.
        const KEY_MAP = {
            '√∫ltima vez nesta escola': 'UltimaVezNestaEscola', 
            'certid√£o de nascimento': 'CertidaoNascimento' 
        };

        // ------------------------------------------
        // FUN√á√ïES DE UTILIDADE E CARREGAMENTO
        // ------------------------------------------

        // üõ†Ô∏è Fun√ß√£o principal para processar o ArrayBuffer do XLSX
        function processWorkbook(dataArrayBuffer, fileName) {
            const workbook = XLSX.read(dataArrayBuffer, { type: 'array' });
            fullData = {}; 

            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                const headers = jsonData[0];
                const rows = jsonData.slice(1);

                const mappedRows = rows.map(row => {
                    let obj = { sheetName: sheetName }; 
                    headers.forEach((header, index) => {
                        const cleanHeader = (header || '').trim();
                        const lowerHeader = cleanHeader.toLowerCase();
                        let cellValue = row[index] !== undefined ? row[index] : '';

                        if (cleanHeader) {
                            let key = cleanHeader;
                            
                            // 1. Aplica o mapeamento para padroniza√ß√£o de chaves problem√°ticas
                            if (KEY_MAP[lowerHeader]) {
                                key = KEY_MAP[lowerHeader];
                            
                            // 2. Padroniza chaves de Caixa
                            } else if (lowerHeader.includes('caixa') || lowerHeader.includes('n¬∫ na caixa')) {
                                key = 'Caixa'; 
                            } else if (lowerHeader.includes('certid√£o') || lowerHeader.includes('certidao')) {
                                key = 'CertidaoNascimento';
                            }
                            
                            obj[key] = cellValue;
                        }
                    });
                    return obj;
                }).filter(row => row['Nome'] && String(row['Nome']).trim() !== '');

                fullData[sheetName] = mappedRows;
            });

            document.getElementById('search-container').style.display = 'block';
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = `<p style="color: ${SUCCESS_COLOR};">‚úÖ Planilha carregada com sucesso! (${fileName.substring(0, 50)}...). Digite para buscar.</p>`;
            document.getElementById('auto-load-message').style.display = 'none';
        }


        // üîÑ L√≥gica de Falha: Mostra o input de arquivo manual
        function showManualInput(message) {
            const autoLoadMsg = document.getElementById('auto-load-message');
            autoLoadMsg.style.backgroundColor = '#fff3cd'; /* Amarelo claro para alerta */
            autoLoadMsg.style.borderLeftColor = '#ffc107'; 
            autoLoadMsg.innerHTML = `<p style="color: ${ERROR_COLOR}; font-weight: 600;">‚ö†Ô∏è Falha no Carregamento Autom√°tico da URL.</p>
                                     <p style="margin-top: 5px;">${message}</p>`;

            document.getElementById('file-label').style.display = 'block';
            document.getElementById('file-input').style.display = 'block';
            document.getElementById('search-results').innerHTML = '<p>Selecione o arquivo XLSX manualmente para iniciar.</p>';
        }

        // 1. üåê Tenta carregar o arquivo pelo caminho local (iniciado no <body> onload)
        async function attemptAutoLoad() {
            const autoLoadMsg = document.getElementById('auto-load-message');
            autoLoadMsg.innerHTML = `**Tentando carregar a planilha automaticamente** da URL do SharePoint: 
                                     <a href="${AUTO_LOAD_PATH}" target="_blank">Clique para tentar abrir a planilha no navegador</a>.`;
            try {
                // Ao carregar de uma URL externa, 'mode: "cors"' √© a op√ß√£o padr√£o 
                // e √© necess√°ria para que o fetch funcione se o servidor SharePoint permitir.
                const response = await fetch(AUTO_LOAD_PATH);
                
                if (!response.ok) {
                    throw new Error(`Falha ao acessar o arquivo (${response.status} ${response.statusText}).`);
                }

                // L√™ o conte√∫do do arquivo como ArrayBuffer
                const dataArrayBuffer = await response.arrayBuffer();
                
                // Processa o arquivo carregado automaticamente
                processWorkbook(dataArrayBuffer, AUTO_LOAD_PATH);

            } catch (error) {
                // Se falhar (erro de rede, CORS, ou arquivo n√£o encontrado)
                console.error("Erro no carregamento autom√°tico:", error);
                showManualInput(`Detalhe: ${error.message}. Isso pode ocorrer por restri√ß√µes de seguran√ßa (CORS) ou se voc√™ n√£o estiver logado no SharePoint. Por favor, localize o arquivo manualmente.`);
            }
        }
        
        // 2. üìÅ Carregamento manual de arquivo (quando o usu√°rio usa o input)
        function handleFileManual(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataArrayBuffer = e.target.result;
                processWorkbook(dataArrayBuffer, file.name);
                document.getElementById('auto-load-message').style.display = 'none';
                document.getElementById('file-label').style.display = 'none';
                document.getElementById('file-input').style.display = 'none';
            };

            reader.readAsArrayBuffer(file);
        }

        // üõ†Ô∏è FUN√á√ÉO DE FORMATA√á√ÉO DE DATA üõ†Ô∏è
        function formatCellValue(cellValue, headerKey) {
            if (typeof cellValue === 'number' && cellValue > 1000) {
                
                if (headerKey === 'UltimaVezNestaEscola') {
                    const formattedYear = XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'yyyy' });
                    if (parseInt(formattedYear) <= 1905) return ''; 
                    return formattedYear;
                }
                
                if (headerKey === 'Nascimento') {
                    return XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'dd/mm/yyyy' });
                }
            }
        
            return String(cellValue) || '';
        }

        // ------------------------------------------
        // FUN√á√ÉO DE BUSCA (performSearch)
        // ------------------------------------------

        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            if (!fullData || Object.keys(fullData).length === 0) {
                resultsDiv.innerHTML = `<p style="color: ${ERROR_COLOR};">Erro: Nenhuma planilha carregada.</p>`;
                return;
            }

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p>Digite pelo menos 2 caracteres para iniciar a busca.</p>';
                return;
            }

            let allResults = [];
            for (const sheetName in fullData) {
                const sheetRows = fullData[sheetName];

                const sheetResults = sheetRows.filter(row => {
                    return Object.values(row).some(cellValue => {
                        let valueString = String(cellValue).toLowerCase();

                        if (typeof cellValue === 'number' && cellValue > 1000) {
                            const formattedDate = XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'dd/mm/yyyy' });
                            valueString = formattedDate.toLowerCase();
                        }
                        
                        return valueString.includes(query);
                    });
                });
                
                allResults = allResults.concat(sheetResults);
            }
            
            // ORDENA√á√ÉO: Ordenar por Aba (sheetName) e depois por N¬∫ na Caixa (Caixa)
            allResults.sort((a, b) => {
                if (a.sheetName < b.sheetName) return -1;
                if (a.sheetName > b.sheetName) return 1;
                return (parseInt(a.Caixa) || 0) - (parseInt(b.Caixa) || 0);
            });

            if (allResults.length > 0) {
                
                // As chaves (keys) aqui S√ÉO AS PADRONIZADAS no JavaScript.
                const displayHeaders = [
                    { key: 'sheetName', title: 'Aba (Letra)' },
                    { key: 'Caixa', title: 'N¬∫ na Caixa' },
                    { key: 'Nome', title: 'Nome' },
                    { key: 'Nascimento', title: 'Nascimento' },
                    { key: 'CertidaoNascimento', title: 'Certid√£o de Nascimento' }, 
                    { key: 'S√©rie/Ano', title: 'S√©rie/Ano' },
                    { key: 'Modalidade', title: 'Modalidade' },
                    { key: 'Filia√ß√£o 1', title: 'Filia√ß√£o 1' },
                    { key: 'UltimaVezNestaEscola', title: '√öltima vez nesta Escola' }, 
                    { key: 'Hist√≥rico', title: 'Hist√≥rico' }
                ];

                let tableHTML = `<p style="color: ${SUCCESS_COLOR};">Encontrados ${allResults.length} resultados:</p>`;
                tableHTML += `<table class="data-table"><thead><tr>`;
                
                displayHeaders.forEach(h => tableHTML += `<th>${h.title}</th>`);
                tableHTML += `</tr></thead><tbody>`;

                allResults.forEach(row => {
                    tableHTML += `<tr>`;
                    
                    displayHeaders.forEach(header => {
                        let value = row[header.key];
                        
                        if (header.key === 'Nascimento' || header.key === 'UltimaVezNestaEscola') {
                            value = formatCellValue(value, header.key);
                        } 
                        
                        tableHTML += `<td>${String(value) || ''}</td>`;
                    });

                    tableHTML += `</tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                resultsDiv.innerHTML = tableHTML;

            } else {
                resultsDiv.innerHTML = `<p style="color: ${ERROR_COLOR};">Nenhum resultado encontrado para "${query}" nas abas.</p>`;
            }
        }
    </script>
</body>
</html>
