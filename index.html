<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>ARQUIVO INATIVO - JOS√â TEIXEIRA FIALHO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Estilos CSS (Mantidos) */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --error-color: #dc3545;
            --background-light: whitesmoke;
            --shadow-subtle: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-input: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        body { 
            font-family: 'Poppins', Arial, sans-serif; 
            background-color: var(--background-light);
            padding: 20px; 
            display: flex;
            justify-content: center;
        }

        .container {
            width: 90%;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow-subtle);
        }

        h1 {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 600;
        }

        h2 {
            color: var(--secondary-color);
            margin-top: 25px;
            font-weight: 400;
            font-size: 1.5rem;
        }

        #input-container, #search-container { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            background-color: #f8f9fa;
            box-shadow: var(--shadow-input);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #343a40;
        }

        #file-input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: white;
        }

        #search-input {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        #search-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        #search-container p {
            font-size: 0.85em; 
            color: var(--secondary-color);
            margin-top: 5px;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 123, 255, 0.75), rgba(0, 0, 0, 0));
            margin: 30px 0;
        }

        #search-results { 
            margin-top: 20px; 
            border: 1px solid #dee2e6;
            border-radius: 8px; 
            padding: 15px; 
            min-height: 100px;
            background-color: white;
            box-shadow: var(--shadow-input);
        }
        
        #search-results p:first-child[style*="#28a745"] {
            font-weight: 600;
        }
        #search-results p[style*="#dc3545"] {
            font-weight: 600;
        }

       .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            /* REMOVIDO: table-layout: fixed; */
            /* Isso permite que a tabela se ajuste ao conte√∫do */
        }
        .data-table th, .data-table td { 
            border: 1px solid #e9ecef; 
            padding: 12px 15px; 
            text-align: left; 
            font-size: 0.70rem;
            
            /* NOVAS REGRAS PARA LARGURA E QUEBRA DE TEXTO */
            width: auto; /* Permite que a largura se ajuste ao conte√∫do */
            max-width: 300px; /* Limita a largura m√°xima da coluna */
            white-space: normal; /* Permite a quebra de linha (wrap) se o texto for muito longo */
            word-wrap: break-word; /* Ajuda a quebrar palavras longas */
            
            overflow: hidden;
            /* REMOVIDO: text-overflow: ellipsis; e white-space: nowrap; para permitir quebra */
        }
        .data-table th { 
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        /* ... (restante do CSS permanece igual) ... */
        .data-table tr:nth-child(even) {
            background-color: #f8f9fa; 
        }
        .data-table tr:hover {
            background-color: #e2f0ff; 
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: scale(0.98);
        }

        #open-xlsx-link {
            text-decoration: none;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>üîç Arquivo Inativo - JOS√â TEIXEIRA FIALHO</h1>

        <div id="input-container">
            <label for="file-input">1. Selecione o arquivo XLSX (Esperado: **Planilha Edit√°vel/ARQUIVO INATIVO - VIGENTE.xlsx**):</label>
            <input type="file" id="file-input" accept=".xlsx" onchange="handleFile(event)">
        </div>

        <div id="search-container" style="display: none;">
            <label for="search-input">2. Digite o que deseja buscar (Nome, Filia√ß√£o, etc.):</label>
            <input type="text" id="search-input" placeholder="Ex: Maria da Silva" onkeyup="performSearch()">
            <p>O campo busca em todas as abas (A-Z) simultaneamente.</p>
        </div>

        <hr>

        <h2>Resultados da Busca:</h2>
        <div id="search-results">
            <p>Aguardando a sele√ß√£o do arquivo...</p>
        </div>
        
        
    </div>

    <script>
        let fullData = {}; 
        const SUCCESS_COLOR = '#28a745';
        const ERROR_COLOR = '#dc3545';
        
        // üéØ KEY_MAP: Mapeia cabe√ßalhos com acentos ou varia√ß√µes para uma chave padronizada no JS.
        const KEY_MAP = {
            
            '√öltima vez nesta Escola': 'UltimaVezNestaEscola',
            'certid√£o de nascimento': 'CertidaoNascimento' 
        };

        // üõ†Ô∏è FUN√á√ÉO DE FORMATA√á√ÉO DE DATA üõ†Ô∏è
        function formatCellValue(cellValue, headerKey) {
            // S√≥ tenta formatar se for um n√∫mero de s√©rie v√°lido (geralmente > 1000)
            if (typeof cellValue === 'number' && cellValue > 1000) {
                
                // Formata como ANO para UltimaVezNestaEscola
                if (headerKey === 'UltimaVezNestaEscola') {
                    const formattedYear = XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'yyyy' });
                    // Limpa anos de erro de s√©rie (como 1900-1905)
                    if (parseInt(formattedYear) <= 1905) return ''; 
                    return formattedYear;
                }
                
                // Formata como DATA COMPLETA para Nascimento
                if (headerKey === 'Nascimento') {
                    // Retorna a data completa
                    return XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'dd/mm/yyyy' });
                }
            }
        
            return String(cellValue) || '';
        }
        
        // üõ†Ô∏è FUN√á√ÉO DE LEITURA E CARREGAMENTO DO ARQUIVO üõ†Ô∏è
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                // Usa 'raw: true' para preservar formatos de n√∫mero e data originais
                const workbook = XLSX.read(data, { type: 'array' });
                
                fullData = {}; 

                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    // Usa 'raw: true' para obter os valores num√©ricos de datas
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);

                    const mappedRows = rows.map(row => {
                        let obj = { sheetName: sheetName }; 
                        headers.forEach((header, index) => {
                            const cleanHeader = (header || '').trim();
                            const lowerHeader = cleanHeader.toLowerCase();
                            let cellValue = row[index] !== undefined ? row[index] : '';

                            if (cleanHeader) {
                                let key = cleanHeader;
                                
                                // 1. Aplica o mapeamento para padroniza√ß√£o de chaves problem√°ticas
                                if (KEY_MAP[lowerHeader]) {
                                    key = KEY_MAP[lowerHeader];
                                
                                // 2. Padroniza chaves de Caixa
                                } else if (lowerHeader.includes('caixa') || lowerHeader.includes('n¬∫ na caixa')) {
                                    key = 'Caixa'; 
                                // üéØ NOVO: Padroniza Certid√£o
                                } else if (lowerHeader.includes('certid√£o') || lowerHeader.includes('certidao')) {
                                    key = 'CertidaoNascimento';
                                }
                                
                                obj[key] = cellValue;
                            }
                        });
                        return obj;
                    }).filter(row => row['Nome'] && String(row['Nome']).trim() !== '');

                    fullData[sheetName] = mappedRows;
                });

                document.getElementById('search-container').style.display = 'block';
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = `<p style="color: ${SUCCESS_COLOR};">‚úÖ Planilha "${file.name}" carregada com sucesso! Digite para buscar.</p>`;

                const openLink = document.getElementById('open-xlsx-link');
                openLink.onclick = () => {
                    alert(`O arquivo j√° est√° no seu computador. Abra o arquivo "${file.name}" diretamente do Explorador de Arquivos/Finder no caminho: Planilha Edit√°vel/ARQUIVO INATIVO - VIGENTE.xlsx`);
                    return false;
                };
            };

            reader.readAsArrayBuffer(file);
        }

        // FUN√á√ÉO DE BUSCA (USA CHAVES PADRONIZADAS)
        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            if (!fullData || Object.keys(fullData).length === 0) {
                resultsDiv.innerHTML = `<p style="color: ${ERROR_COLOR};">Erro: Nenhuma planilha carregada.</p>`;
                return;
            }

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p>Digite pelo menos 2 caracteres para iniciar a busca.</p>';
                return;
            }

            let allResults = [];
            for (const sheetName in fullData) {
                const sheetRows = fullData[sheetName];

                const sheetResults = sheetRows.filter(row => {
                    return Object.values(row).some(cellValue => {
                        // Converte a data de n√∫mero de s√©rie para string formatada APENAS para a busca, se for um n√∫mero de data
                        let valueString = String(cellValue).toLowerCase();

                        if (typeof cellValue === 'number' && cellValue > 1000) {
                            // Tenta formatar a data como dd/mm/yyyy para incluir datas na busca
                            const formattedDate = XLSX.utils.format_cell({ t: 'n', v: cellValue, z: 'dd/mm/yyyy' });
                            valueString = formattedDate.toLowerCase();
                        }
                        
                        return valueString.includes(query);
                    });
                });
                
                allResults = allResults.concat(sheetResults);
            }
            
            // ORDENA√á√ÉO: Ordenar por Aba (sheetName) e depois por N¬∫ na Caixa (Caixa)
            allResults.sort((a, b) => {
                if (a.sheetName < b.sheetName) return -1;
                if (a.sheetName > b.sheetName) return 1;
                // Ordena√ß√£o por Caixa (garante que n√∫meros s√£o tratados como n√∫meros)
                return (parseInt(a.Caixa) || 0) - (parseInt(b.Caixa) || 0);
            });

            if (allResults.length > 0) {
                
                // As chaves (keys) aqui S√ÉO AS PADRONIZADAS no JavaScript.
                const displayHeaders = [
                    { key: 'sheetName', title: 'Aba (Letra)' },
                    { key: 'Caixa', title: 'N¬∫ na Caixa' },
                    { key: 'Nome', title: 'Nome' },
                    { key: 'Nascimento', title: 'Nascimento' },
                    // üéØ NOVA COLUNA AQUI
                    { key: 'CertidaoNascimento', title: 'Certid√£o de Nascimento' }, 
                    { key: 'S√©rie/Ano', title: 'S√©rie/Ano' },
                    { key: 'Modalidade', title: 'Modalidade' },
                    { key: 'Filia√ß√£o 1', title: 'Filia√ß√£o 1' },
                    { key: '√öltima vez nesta Escola', title: '√öltima vez nesta Escola' }, // CHAVE PADRONIZADA
                    { key: 'Hist√≥rico', title: 'Hist√≥rico' }
                ];

                let tableHTML = `<p style="color: ${SUCCESS_COLOR};">Encontrados ${allResults.length} resultados:</p>`;
                tableHTML += `<table class="data-table"><thead><tr>`;
                
                displayHeaders.forEach(h => tableHTML += `<th>${h.title}</th>`);
                tableHTML += `</tr></thead><tbody>`;

                allResults.forEach(row => {
                    tableHTML += `<tr>`;
                    
                    displayHeaders.forEach(header => {
                        let value = row[header.key];
                        
                        // Aplica Formata√ß√£o de Datas/Ano para exibi√ß√£o
                        if (header.key === 'Nascimento' || header.key === 'UltimaVezNestaEscola') {
                            value = formatCellValue(value, header.key);
                        } 
                        
                        // Certid√£o de Nascimento √© exibido como string.
                        
                        tableHTML += `<td>${String(value) || ''}</td>`;
                    });

                    tableHTML += `</tr>`;
                });
                
                tableHTML += `</tbody></table>`;
                resultsDiv.innerHTML = tableHTML;

            } else {
                resultsDiv.innerHTML = `<p style="color: ${ERROR_COLOR};">Nenhum resultado encontrado para "${query}" nas abas.</p>`;
            }
        }
    </script>
</body>
</html>
